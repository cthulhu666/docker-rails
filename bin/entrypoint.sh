#!/bin/bash

#set -eu

appHelp () {
	echo "Available options:"
	echo " app:start          - Starts the rails server "
	echo " app:help           - Displays the help (default)"
	echo " [command]          - Execute the specified linux command eg. bash."
}

appStart () {
    echo "Starting rails application ..."

    PROCFILE=${PROCFILE-Procfile}
    echo "Using Procfile: $PROCFILE"

    env | grep PORT > .env-autogenerated # preserve env vars set by docker
    foreman export supervisord /tmp -a app -u ruby -l "/app/log" -f "/app/$PROCFILE" -e .env-autogenerated
    sed -i s:bundle:`which bundle`: /tmp/app.conf
    sudo cp /tmp/app.conf /etc/supervisor/conf.d/
    exec sudo /usr/bin/supervisord -n -c /etc/supervisor/supervisord.conf
}



case "$1" in
	app:start)
		appStart
		;;
	app:help)
		appHelp
		;;
	*)
		if [ -x $1 ]; then
			$1
		else
			prog=$(which $1)
			if [ -n "${prog}" ] ; then
				shift 1
				$prog $@
			else
				appHelp
			fi
		fi
		;;
esac